<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AI Pikachu</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .pikachu-area {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
        }

        .model-container {
            width: 400px;
            height: 400px;
            border: 2px dashed #ccc;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #888;
            font-size: 18px;
        }

        .model-placeholder {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .chat-area {
            flex: 1;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
        }

        .chat-header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 160px);
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .pikachu-message {
            background: #ffe066;
            color: #333;
            border: 2px solid #ffcc00;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        #messageInput:focus {
            border-color: #4a90e2;
        }

        #sendButton {
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        #sendButton:hover {
            background: #357abd;
        }

        #sendButton:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .status.thinking {
            background: #ffc107;
            color: #333;
        }

        .status.speaking {
            background: #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }

        .api-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .setup-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="pikachu-area">
            <div class="setup-panel" id="setupPanel">
                <h3>API Setup</h3>
                <input type="password" id="anthropicKey" class="api-input" placeholder="Anthropic API Key">
                <input type="password" id="elevenlabsKey" class="api-input" placeholder="ElevenLabs API Key">
                <button class="setup-button" onclick="saveKeys()">Save Keys</button>
                <button class="setup-button" onclick="toggleSetup()">Hide Panel</button>
            </div>
            
            <div class="status" id="status">Ready</div>
            
            <div class="model-container" id="modelContainer">
                <div class="model-placeholder">⚡</div>
                <div>Pikachu VTuber Model</div>
                <div style="font-size: 14px; margin-top: 10px; text-align: center;">
                    Model will be integrated here<br>
                    Currently showing placeholder
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                Chat with AI Pikachu ⚡
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message pikachu-message">
                    Pika pika! Hi there! I'm your AI Pikachu friend. What would you like to talk about? ⚡
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <input type="text" id="messageInput" placeholder="Type your message to Pikachu..." onkeypress="handleKeyPress(event)">
                    <button id="sendButton" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let anthropicApiKey = '';
        let elevenlabsApiKey = '';
        let isProcessing = false;
        let currentAudio = null;

        // Load saved API keys
        window.addEventListener('load', () => {
            anthropicApiKey = localStorage.getItem('anthropicApiKey') || '';
            elevenlabsApiKey = localStorage.getItem('elevenlabsApiKey') || '';
            
            if (anthropicApiKey) {
                document.getElementById('anthropicKey').value = '••••••••';
            }
            if (elevenlabsApiKey) {
                document.getElementById('elevenlabsKey').value = '••••••••';
            }
            
            if (anthropicApiKey && elevenlabsApiKey) {
                document.getElementById('setupPanel').style.display = 'none';
            }
        });

        function saveKeys() {
            const anthropicInput = document.getElementById('anthropicKey');
            const elevenlabsInput = document.getElementById('elevenlabsKey');
            
            if (anthropicInput.value && anthropicInput.value !== '••••••••') {
                anthropicApiKey = anthropicInput.value;
                localStorage.setItem('anthropicApiKey', anthropicApiKey);
            }
            
            if (elevenlabsInput.value && elevenlabsInput.value !== '••••••••') {
                elevenlabsApiKey = elevenlabsInput.value;
                localStorage.setItem('elevenlabsApiKey', elevenlabsApiKey);
            }
            
            if (anthropicApiKey && elevenlabsApiKey) {
                alert('API keys saved successfully!');
                document.getElementById('setupPanel').style.display = 'none';
            } else {
                alert('Please enter both API keys');
            }
        }

        function toggleSetup() {
            const panel = document.getElementById('setupPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateStatus(message, type = 'ready') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function addMessage(message, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'user-message' : 'pikachu-message');
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            if (!anthropicApiKey || !elevenlabsApiKey) {
                alert('Please set up your API keys first!');
                document.getElementById('setupPanel').style.display = 'block';
                return;
            }

            input.value = '';
            isProcessing = true;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, true);
            updateStatus('Pikachu is thinking...', 'thinking');

            try {
                // Get AI response from Anthropic
                const aiResponse = await getAIResponse(message);
                addMessage(aiResponse, false);
                
                updateStatus('Pikachu is speaking...', 'speaking');
                
                // Generate speech with ElevenLabs
                await generateSpeech(aiResponse);
                
                updateStatus('Ready', 'ready');
                
            } catch (error) {
                console.error('Error:', error);
                addMessage('Pika pika... Sorry, I had trouble understanding that. Can you try again?', false);
                updateStatus('Ready', 'ready');
            } finally {
                isProcessing = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        async function getAIResponse(userMessage) {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You are Pikachu, the beloved electric-type Pokémon! Respond to this message in character as Pikachu. Be friendly, energetic, and occasionally use "Pika pika!" in your responses. Keep responses conversational and not too long. Here's the message: ${userMessage}`
                        }]
                    })
                });

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('Anthropic API error:', error);
                return 'Pika pika! Something went wrong with my thinking. Try again!';
            }
        }

        async function generateSpeech(text) {
            try {
                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB', {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': elevenlabsApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_monolingual_v1",
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.5
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                    
                    currentAudio = new Audio(audioUrl);
                    
                    // Enhanced lip sync with audio analysis
                    currentAudio.addEventListener('play', () => {
                        animateLipSyncWithAudio(currentAudio);
                    });
                    
                    currentAudio.addEventListener('ended', () => {
                        stopLipSync();
                        updateStatus('Ready', 'ready');
                    });
                    
                    await currentAudio.play();
                }
            } catch (error) {
                console.error('ElevenLabs API error:', error);
            }
        }

        // Placeholder functions for VTuber model integration
        function startLipSync() {
            // This will be where we trigger the Live2D model lip sync
            console.log('Starting lip sync animation');
            // TODO: Integrate with Live2D model
        }

        function stopLipSync() {
            // This will be where we stop the Live2D model lip sync
            console.log('Stopping lip sync animation');
            // TODO: Stop Live2D model animation
        }

        // Keyboard shortcut to toggle setup panel
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                toggleSetup();
            }
        });
    </script>
</body>
</html>
